<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„Ø¯ÙØ¹</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --aliexpress-red: #FF4747; 
    --bg-color: #f2f2f2;
    --card-bg: #ffffff;
    --text-color: #222;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body {
    font-family: 'Tajawal', sans-serif; margin: 0; background: var(--bg-color); padding-bottom: 50px;
  }
  header {
    background: #fff; padding: 15px; text-align: center; border-bottom: 1px solid #eee;
    font-size: 18px; font-weight: 700; color: var(--aliexpress-red);
  }
  .container { padding: 15px; max-width: 600px; margin: 0 auto; }
  
  /* Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
  .info-form {
    background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.03);
  }
  label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: 600; color: #555; }
  input, textarea {
    width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd;
    border-radius: 8px; font-family: inherit; font-size: 14px;
  }
  textarea { resize: vertical; }

  /* ğŸ”¥ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¯ÙØ¹ */
  .payment-options-card { margin-top: 20px; }
  .payment-radio-group {
    border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 15px;
    background: #fff;
  }
  .payment-radio-group label {
    display: flex; align-items: center; cursor: pointer; padding: 10px 0;
    font-weight: 700; color: #333;
  }
  .payment-details {
    background: #f9f9f9; border-radius: 8px; padding: 15px; margin-top: 10px;
    border: 1px dashed #eee; font-size: 13px; line-height: 1.6;
  }
  .pay-method-title { font-size: 14px; font-weight: 800; color: var(--aliexpress-red); margin-bottom: 5px; }
  .pay-detail-item { margin-bottom: 8px; }
  .pay-detail-item span { font-weight: 600; color: #000; }
  
  /* ğŸ”¥ Ø±ÙØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± */
  #uploadProofBox {
    margin-top: 15px;
    border: 1px solid #FFC000; padding: 15px; border-radius: 8px;
    background: #fffef2;
    transition: 0.3s;
  }
  #uploadProofBox.hidden { opacity: 0; height: 0; padding: 0; margin: 0; overflow: hidden; }
  .upload-btn-label {
    display: block; padding: 10px; background: #FFD700; color: #333;
    border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer;
  }
  #proofPreview { max-width: 100%; height: auto; margin-top: 10px; border-radius: 8px; display: none; }


  /* Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨ */
  .summary-card { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #eee; margin-top: 15px; }
  .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
  .total-row { border-top: 2px dashed #eee; padding-top: 10px; font-weight: 700; font-size: 16px; }
  .final-price { color: var(--aliexpress-red); font-size: 20px; font-weight: 800; }

  /* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
  .submit-btn {
    width: 100%; padding: 15px; margin-top: 25px; border: none;
    background: linear-gradient(90deg, #FF8238, #FF4747);
    color: #fff; font-size: 16px; font-weight: bold; border-radius: 99px;
    box-shadow: 0 4px 10px rgba(255, 71, 71, 0.4);
    cursor: pointer;
  }
  .submit-btn:disabled { opacity: 0.7; cursor: not-allowed; }
  
  .cart-item { margin-bottom: 10px; border-bottom: 1px dotted #eee; padding-bottom: 5px; }
  .cart-item span { font-weight: 600; }
  
  .error-message { color: var(--aliexpress-red); text-align: center; margin-top: 20px; font-weight: bold; }
</style>
</head>
<body>

<header>ğŸ›’ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</header>

<div class="container">
  
  <div class="info-form">
    <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h3>
    <label for="clientName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
    <input type="text" id="clientName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨" required>

    <label for="clientPhone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</label>
    <input type="tel" id="clientPhone" placeholder="967XXXXXXXX" required>

    <label for="clientLocation">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ù„Ø­ÙŠ):</label>
    <textarea id="clientLocation" placeholder="Ù…Ø«Ø§Ù„: ØµÙ†Ø¹Ø§Ø¡ - Ø­ÙŠ Ø§Ù„Ø£ØµØ¨Ø­ÙŠ - Ø¬ÙˆØ§Ø± Ù…Ø¯Ø±Ø³Ø© ÙƒØ°Ø§" required></textarea>
  </div>

  <div class="info-form payment-options-card">
    <h3>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h3>
    
    <div class="payment-radio-group">
      <label>
        <input type="radio" name="paymentMethod" value="cash" checked onchange="toggleProofUpload('cash')">
        Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
      </label>
    </div>

    <div class="payment-radio-group">
      <label>
        <input type="radio" name="paymentMethod" value="wallet" onchange="toggleProofUpload('wallet')">
        Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© / Ø§Ù„Ø­ÙˆØ§Ù„Ø©
      </label>
      
      <div class="payment-details" id="walletDetails">
        <p class="pay-method-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ (ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¯ÙØ¹ Ù‚Ø¨Ù„ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨):</p>
        
        <p class="pay-detail-item">
            **Ù†Ù‚Ø·Ø© Ø­Ø§Ø³Ø¨ ÙƒØ±ÙŠÙ…ÙŠ (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø­Ù„)**<br>
            Ø§Ù„Ø±Ù‚Ù…: <span>1760018</span>
        </p>
        <p class="pay-detail-item">
            **Ù†Ù‚Ø·Ø© Ø¯ÙØ¹ Ù…Ø´ØªØ±ÙŠØ§Øª Ø¬ÙŠØ¨**<br>
            Ø§Ù„Ø±Ù‚Ù…: <span>514298</span>
        </p>
        
        <hr style="border:none; border-top:1px dotted #ccc;">
        
        <p class="pay-detail-item">
            **Ø­ÙˆØ§Ù„Ø© Ø¹Ø§Ø¯ÙŠØ©/Ù…Ø­Ø§ÙØ¸ (ÙƒØ±ÙŠÙ…ÙŠØŒ Ø¬ÙŠØ¨ØŒ Ø¬ÙˆØ§Ù„ÙŠØŒ ÙˆÙ† ÙƒØ§Ø´ØŒ ÙƒØ§Ø´)**<br>
            Ø¨Ø§Ø³Ù…: <span>Ø®Ù„ÙŠÙ„ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¹Ù„ÙŠ Ø§Ø­Ù…Ø¯ ÙØ±Ø­Ø§Ù†</span><br>
            Ø§Ù„Ø±Ù‚Ù… (ÙŠÙ…Ù†ÙŠ): <span>773266534</span><br>
            Ø§Ù„Ø±Ù‚Ù… (Ø³Ø¹ÙˆØ¯ÙŠ): <span>3079221626</span>
        </p>
      </div>
    </div>
    
    <div id="uploadProofBox" class="hidden">
        <label for="paymentProofInput" class="upload-btn-label">
            ğŸ“¸ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯ÙØ¹ (Ø¶Ø±ÙˆØ±ÙŠ)
        </label>
        <input type="file" id="paymentProofInput" accept="image/*" style="display:none;" onchange="previewProof(this)">
        <img id="proofPreview" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±">
    </div>
  </div>


  <div class="summary-card">
    <h3>Ù…Ù„Ø®Øµ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
    <div id="orderItemsSummary"></div>
    
    <div class="summary-row">
        <span>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„:</span>
        <span id="shippingSummary">0 Ø±.ÙŠ</span>
    </div>

    <div class="total-row">
        <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
        <span class="final-price" id="finalTotalSummary">0 Ø±.ÙŠ</span>
    </div>
  </div>

  <button id="submitOrderBtn" class="submit-btn" onclick="submitOrder()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
  <div id="errorMessage" class="error-message" style="display:none;"></div>
  
  <div id="successMessage" class="error-message" style="color:green; display:none;">
    âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.
    <br><a href="index.html" style="color:var(--aliexpress-red); text-decoration:none;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</a>
  </div>
</div>

<script type="module">
  // ğŸ”¥ğŸ”¥ğŸ”¥ Ø¨ÙŠØ§Ù†Ø§Øª Firebase (ÙŠØ¬Ø¨ Ù†Ø³Ø®Ù‡Ø§ Ù…Ù† index.html) ğŸ”¥ğŸ”¥ğŸ”¥
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB5mEBB0plzw_d-gAth-TK0xR523IX6nGg",
    authDomain: "my-fils-575be.firebaseapp.com",
    projectId: "my-fils-575be",
    storageBucket: "my-fils-575be.firebasestorage.app",
    messagingSenderId: "670428095338",
    appId: "1:670428095338:web:75d4a577cc648c208d7b13"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const ordersCol = collection(db, "orders"); 

  let currentCart = [];
  let finalTotalAmount = 0;
  let shippingDetails = {};
  let paymentProofImage = ''; // ğŸ”¥ Ù„ØªØ®Ø²ÙŠÙ† ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  let currentPaymentMethod = 'cash'; // ğŸ”¥ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©

  // ------------------------------------------------------------------
  // 1. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù€ DOM ÙˆØ§Ù„Ø¹Ø±Ø¶
  // ------------------------------------------------------------------
  function loadCartSummary() {
    const cartData = JSON.parse(localStorage.getItem("cart")) || [];
    const summaryData = JSON.parse(localStorage.getItem("checkoutSummary")) || null;
    
    if (cartData.length === 0 || !summaryData) {
        document.querySelector('.container').innerHTML = '<div class="error-message">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>';
        return;
    }
    
    currentCart = cartData;
    finalTotalAmount = summaryData.finalTotal;
    shippingDetails = summaryData.shipping;
    
    const itemsContainer = document.getElementById("orderItemsSummary");
    let productSubtotal = 0;
    itemsContainer.innerHTML = '<h4>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</h4>';
    
    cartData.forEach(item => {
        const rawPrice = parseFloat(item.price.toString().replace(/[^0-9.]/g, '')) || 0;
        const itemTotal = rawPrice * item.qty;
        productSubtotal += itemTotal;
        
        itemsContainer.innerHTML += `
            <div class="cart-item">
                <span>${item.name}</span> (Ø§Ù„Ø¹Ø¯Ø¯: ${item.qty}) 
                - ${itemTotal.toLocaleString()} Ø±.ÙŠ
            </div>
        `;
    });
    
    document.getElementById("shippingSummary").textContent = shippingDetails.cost.toLocaleString() + " Ø±.ÙŠ (" + shippingDetails.location + ")";
    document.getElementById("finalTotalSummary").textContent = finalTotalAmount.toLocaleString() + " Ø±.ÙŠ";
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¥Ø°Ø§ Ø§Ø®ØªÙŠØ±Øª Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ "Ø§Ù„Ù…Ø­ÙØ¸Ø©" ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    toggleProofUpload('cash'); 
  }

  // ğŸ”¥ ÙˆØ¸ÙŠÙØ© ØªØ¨Ø¯ÙŠÙ„ Ø®ÙŠØ§Ø±Ø§Øª Ø±ÙØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  window.toggleProofUpload = function(method) {
    currentPaymentMethod = method;
    const box = document.getElementById("uploadProofBox");
    if (method === 'wallet') {
      box.classList.remove('hidden');
    } else {
      box.classList.add('hidden');
    }
  }

  // ğŸ”¥ Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù€ Base64
  window.previewProof = function(input) {
      const file = input.files[0];
      const preview = document.getElementById('proofPreview');
      
      if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
              paymentProofImage = e.target.result; // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ±
              preview.src = e.target.result;
              preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
      } else {
          paymentProofImage = '';
          preview.style.display = 'none';
      }
  }

  // ------------------------------------------------------------------
  // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Firebase
  // ------------------------------------------------------------------
  window.submitOrder = async function() {
    const name = document.getElementById("clientName").value.trim();
    const phone = document.getElementById("clientPhone").value.trim();
    const location = document.getElementById("clientLocation").value.trim();
    const btn = document.getElementById("submitOrderBtn");
    const errorBox = document.getElementById("errorMessage");

    if (!name || !phone || !location) {
        errorBox.textContent = "âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¬ÙˆØ§Ù„ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†).";
        errorBox.style.display = 'block';
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±ÙØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ù‡ÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø©
    if (currentPaymentMethod === 'wallet' && !paymentProofImage) {
        errorBox.textContent = "âŒ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯ÙØ¹ Ù‚Ø¨Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨.";
        errorBox.style.display = 'block';
        return;
    }

    errorBox.style.display = 'none';
    btn.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨...";
    btn.disabled = true;

    try {
        await addDoc(ordersCol, {
            clientName: name,
            clientPhone: phone,
            clientLocation: location,
            orderTime: new Date().toISOString(),
            orderStatus: "Ø¬Ø¯ÙŠØ¯",
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            paymentMethod: currentPaymentMethod === 'cash' ? 'Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…' : 'Ù…Ø­ÙØ¸Ø©/Ø­ÙˆØ§Ù„Ø© (Ù…Ø¯ÙÙˆØ¹ Ù…Ø³Ø¨Ù‚Ø§Ù‹)',
            paymentProof: paymentProofImage, // ğŸ”¥ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯ÙØ¹ (Base64)
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
            items: currentCart.map(item => ({
                id: item.id,
                name: item.name,
                qty: item.qty,
                price: item.price
            })),
            
            shippingDetails: shippingDetails,
            finalTotal: finalTotalAmount
        });

        // Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©
        localStorage.removeItem("cart");
        localStorage.removeItem("checkoutSummary");
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        document.getElementById('successMessage').style.display = 'block';
        document.querySelector('.info-form').style.display = 'none';
        document.querySelector('.summary-card').style.display = 'none';
        btn.style.display = 'none';

    } catch (e) {
        console.error("Error submitting order: ", e);
        errorBox.textContent = "âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
        errorBox.style.display = 'block';
        btn.textContent = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†";
        btn.disabled = false;
    }
  }

  loadCartSummary();
</script>

</body>
</html>
