<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ | Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø±</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
    --main:#001F3F;
    --secondary:#FF8C00;
}
body{
    margin:0;
    font-family:'Tajawal',sans-serif;
    background:#fff;
    color:var(--main);
}
header{
    position:sticky;
    top:0;
    background:#fff;
    padding:12px;
    display:flex;
    align-items:center;
    gap:10px;
    box-shadow:0 2px 8px rgba(0,0,0,.06);
    z-index:10;
}
header button{
    border:none;
    background:none;
    font-size:20px;
    cursor:pointer;
}
main{
    max-width:900px;
    margin:auto;
    padding:15px;
}

/* ====== Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ====== */
.slider{
    position:relative;
    overflow:hidden;
    border-radius:14px;
}
.slides{
    display:flex;
    transition:transform .3s ease;
}
.slides img{
    width:100%;
    flex-shrink:0;
    object-fit:cover;
}
.dots{
    display:flex;
    justify-content:center;
    gap:6px;
    margin-top:8px;
}
.dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ccc;
}
.dot.active{
    background:var(--secondary);
}

/* ====== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ ====== */
.name{
    font-size:20px;
    font-weight:800;
    margin-top:15px;
}
.price{
    font-size:22px;
    font-weight:900;
    color:var(--secondary);
    margin:8px 0;
}
.desc{
    color:#555;
    line-height:1.6;
}

/* ====== Ø£Ø²Ø±Ø§Ø± ====== */
.actions{
    margin-top:20px;
    display:flex;
    gap:10px;
}
.actions button{
    flex:1;
    padding:14px;
    font-size:16px;
    font-weight:800;
    border-radius:10px;
    border:none;
    cursor:pointer;
}
.add-cart{background:var(--secondary);color:#fff;}
.buy-now{background:var(--main);color:#fff;}

/* ====== Ù…Ù†ØªØ¬Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø© ====== */
.similar{
    margin-top:35px;
}
.similar h3{
    margin-bottom:10px;
}
.similar-grid{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:10px;
}
.similar-card{
    border:1px solid #eee;
    border-radius:10px;
    overflow:hidden;
    cursor:pointer;
}
.similar-card img{
    width:100%;
    aspect-ratio:1/1;
    object-fit:cover;
}
.similar-card div{
    padding:8px;
    font-size:13px;
    font-weight:700;
}
</style>
</head>

<body>

<header>
    <button onclick="history.back()">â†</button>
    <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</strong>
</header>

<main id="content">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

/* Firebase */
const app = initializeApp({
    apiKey: "AIzaSyB5mEBB0plplzw_d-gAth-TK0xR523IX6nGg",
    authDomain: "my-fils-575be.firebaseapp.com",
    projectId: "my-fils-575be",
});
const db = getFirestore(app);

/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø© */
const SAR_RATE = 140;
let currentCurrency = localStorage.getItem("currentCurrency") || "YER";

/* Ù‚Ø±Ø§Ø¡Ø© ID */
const id = new URLSearchParams(location.search).get("id");
const content = document.getElementById("content");

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ */
const snap = await getDoc(doc(db,"products",id));
if(!snap.exists()){
    content.innerHTML="Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
    throw "";
}
const p = snap.data();
const images = Array.isArray(p.image)?p.image:[p.image];

/* Ø§Ù„Ø³Ø¹Ø± */
let priceVal = parseFloat((p.price||"").replace(/\D/g,""))||0;
let displayPrice = currentCurrency==="SAR"
    ? Math.ceil(priceVal/SAR_RATE)+" Ø±.Ø³"
    : priceVal.toLocaleString()+" Ø±.ÙŠ";

/* HTML */
content.innerHTML = `
<div class="slider">
    <div class="slides" id="slides">
        ${images.map(i=>`<img src="${i}">`).join("")}
    </div>
</div>
<div class="dots" id="dots"></div>

<div class="name">${p.name||""}</div>
<div class="price">${displayPrice}</div>
<div class="desc">${p.description||"Ù…Ù†ØªØ¬ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø© Ù…Ù† Ù…ØªØ¬Ø± Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø±"}</div>

<div class="actions">
    <button class="add-cart" onclick="addToCart()">ğŸ›’ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
    <button class="buy-now" onclick="buyNow()">ğŸ“± Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
</div>

<div class="similar">
    <h3>Ù…Ù†ØªØ¬Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø©</h3>
    <div class="similar-grid" id="similarGrid"></div>
</div>
`;

/* ====== Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ====== */
const slides = document.getElementById("slides");
const dots = document.getElementById("dots");
let index=0;

images.forEach((_,i)=>{
    const d=document.createElement("div");
    d.className="dot"+(i===0?" active":"");
    d.onclick=()=>show(i);
    dots.appendChild(d);
});
function show(i){
    index=i;
    slides.style.transform=`translateX(-${i*100}%)`;
    [...dots.children].forEach((d,di)=>d.classList.toggle("active",di===i));
}

/* ====== Ø§Ù„Ø³Ù„Ø© (Ù†ÙØ³ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) ====== */
window.addToCart=function(){
    let cart=JSON.parse(localStorage.getItem("cart")||"[]");
    let item=cart.find(x=>x.id===id);
    if(item) item.qty++;
    else cart.push({id,name:p.name,price:p.price,qty:1});
    localStorage.setItem("cart",JSON.stringify(cart));
    alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© âœ…");
}

window.buyNow=function(){
    const msg=`Ø·Ù„Ø¨ Ù…Ù†ØªØ¬:\n${p.name}\nØ§Ù„Ø³Ø¹Ø±: ${displayPrice}`;
    window.open(`https://wa.me/967773266534?text=${encodeURIComponent(msg)}`);
}

/* ====== Ù…Ù†ØªØ¬Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø© ====== */
const all = await getDocs(collection(db,"products"));
const similarGrid=document.getElementById("similarGrid");

all.docs
.map(d=>({id:d.id,...d.data()}))
.filter(x=>x.category===p.category && x.id!==id)
.slice(0,4)
.forEach(s=>{
    const img = Array.isArray(s.image)?s.image[0]:s.image;
    similarGrid.innerHTML+=`
    <div class="similar-card" onclick="location.href='product.html?id=${s.id}'">
        <img src="${img}">
        <div>${s.name}</div>
    </div>`;
});
</script>

</body>
</html>
