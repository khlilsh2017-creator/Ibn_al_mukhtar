<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #c6a047;
      --bg-color: #f8f9fa;
      --card-bg: #ffffff;
      --text-color: #333;
      --danger: #dc3545;
      --edit-bg: #e0f2f1; --edit-color: #00897b;
      --delete-bg: #ffe5e5;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--bg-color); color: var(--text-color);
      margin: 0; padding: 70px 0 40px;
    }
    
    header {
      position: fixed; top: 0; left: 0; right: 0;
      height: 60px; background: #fff;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 1000;
    }
    header h1 { margin: 0; font-size: 18px; font-weight: 800; color: var(--primary); }
    .home-link {
      text-decoration: none; font-size: 14px; font-weight: bold; color: #333;
      background: #eee; padding: 6px 15px; border-radius: 20px;
    }
    
    .container { max-width: 800px; margin: 0 auto; padding: 16px; }
    
    .card {
      background: var(--card-bg); border-radius: 16px;
      padding: 20px; margin-bottom: 20px;
      border: 1px solid #f0f0f0; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    }
    h2 { margin-top: 0; font-size: 16px; color: var(--primary); border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; }

    /* Ø§Ù„Ø¨Ø­Ø« */
    .search-box { position: relative; margin-bottom: 20px; }
    .search-box input {
        width: 100%; padding: 12px 40px 12px 12px;
        border-radius: 12px; border: 1px solid #ddd;
        font-family: inherit; font-size: 14px; outline: none;
    }
    .search-icon { position: absolute; right: 12px; top: 12px; color: #999; }

    /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
    .product-row {
        display: flex; align-items: center; justify-content: space-between;
        background: #fff; padding: 12px; margin-bottom: 12px;
        border-radius: 12px; border: 1px solid #eee;
    }
    .p-info { display: flex; align-items: center; gap: 12px; flex-grow: 1; }
    .p-img {
        width: 50px; height: 50px; border-radius: 8px;
        object-fit: cover; background: #eee; border: 1px solid #ddd;
    }
    .p-details div:first-child { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
    .p-details div:last-child { font-size: 12px; color: var(--primary); font-weight: 700; }

    .product-actions { display: flex; gap: 8px; flex-shrink: 0; }
    .btn-action {
        padding: 8px 14px; border-radius: 8px; border: none;
        font-size: 12px; font-weight: bold; cursor: pointer; white-space: nowrap;
    }
    .btn-edit { background: var(--edit-bg); color: var(--edit-color); }
    .btn-delete { background: var(--delete-bg); color: var(--danger); }

    .load-more-btn {
        display: block; width: 100%; padding: 12px;
        background: #eee; color: #555; border: none;
        border-radius: 12px; font-weight: bold; cursor: pointer;
        margin-top: 15px; text-align: center;
    }
    .hidden { display: none; }

    /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
    .modal {
        display: none; position: fixed; z-index: 2000;
        left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
        align-items: center; justify-content: center;
    }
    .modal-content {
        background: #fff; padding: 20px; border-radius: 16px;
        width: 90%; max-width: 500px; position: relative;
        max-height: 90vh; overflow-y: auto;
    }
    .close-btn {
        position: absolute; top: 15px; right: 15px;
        background: none; border: none; font-size: 24px; cursor: pointer; color: #999;
    }
    
    label { display: block; margin-bottom: 6px; font-size: 12px; font-weight: bold; color: #666; }
    .input-field {
        width: 100%; padding: 12px; border-radius: 10px;
        border: 1px solid #ddd; background: #fafafa;
        margin-bottom: 12px; font-family: inherit; font-size: 14px;
    }

    /* ØµÙˆØ± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
    .upload-area {
        border: 2px dashed #ccc; padding: 15px;
        text-align: center; border-radius: 10px;
        cursor: pointer; margin-bottom: 10px; background: #fdfdfd;
    }
    .thumbs-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 15px; }
    .thumb-wrapper { position: relative; flex-shrink: 0; }
    .thumb-wrapper img { width: 70px; height: 70px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; }
    .thumb-remove {
        position: absolute; top: -6px; right: -6px;
        background: var(--danger); color: #fff;
        border: none; border-radius: 50%; width: 20px; height: 20px;
        font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    .btn-save-main {
        width: 100%; padding: 14px; background: var(--primary);
        color: #fff; border: none; border-radius: 12px;
        font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px;
    }
  </style>
</head>
<body>

<header>
  <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
  <a href="admin.html" class="home-link">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ğŸ </a>
</header>

<div class="container">
  <div class="card">
    <h2>ğŸ“¦ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (<span id="count">0</span>)</h2>
    
    <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±..." oninput="handleSearch(this.value)">
    </div>

    <div id="productsList"></div>
    
    <button id="loadMoreBtn" class="load-more-btn hidden" onclick="loadNextBatch()">â¬‡ï¸ Ø¹Ø±Ø¶ 10 Ù…Ù†ØªØ¬Ø§Øª Ø£Ø®Ø±Ù‰</button>
    <div id="loadingMsg" style="text-align:center; color:#777; margin-top:10px; display:none;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal()">&times;</button>
        <h2>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h2>
        
        <input type="hidden" id="editProductId">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
        <input type="text" id="editName" class="input-field">
        <label>Ø§Ù„Ø³Ø¹Ø±</label>
        <input type="number" id="editPrice" class="input-field">
        <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
        <select id="editCategorySelect" class="input-field"></select>
        <label>Ø§Ù„ÙˆØµÙ</label>
        <textarea id="editDesc" class="input-field" rows="3"></textarea>

        <label>Ø¥Ø¶Ø§ÙØ© ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</label>
        <div class="upload-area" onclick="document.getElementById('editImagesInput').click()">
            ğŸ“· Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±
        </div>
        <input type="file" id="editImagesInput" accept="image/*" multiple style="display:none;">
        <div id="newImagesPreview" class="thumbs-container"></div>

        <label>Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ø¶ØºØ· X Ù„Ù„Ø­Ø°Ù)</label>
        <div id="currentImagesPreview" class="thumbs-container"></div>
        
        <button id="saveBtn" class="btn-save-main" onclick="submitEditProduct()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, getDocs, deleteDoc, doc, updateDoc, query, limit, startAfter, orderBy, startAt, endAt } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  
  // ğŸ”¥ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
  const firebaseConfig = {
    apiKey: "AIzaSyB5mEBB0plzw_d-gAth-TK0xR523IX6nGg",
    authDomain: "my-fils-575be.firebaseapp.com",
    projectId: "my-fils-575be",
    storageBucket: "my-fils-575be.firebasestorage.app",
    messagingSenderId: "670428095338",
    appId: "1:670428095338:web:75d4a577cc648c208d7b13"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const productsCol = collection(db, "products");
  const categoriesCol = collection(db, "categories");

  let lastVisibleDoc = null;
  const PRODUCTS_PER_PAGE = 10;
  let isFetching = false;
  let searchTimeout = null;

  // ==========================================
  // 1. Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª)
  // ==========================================
  async function loadFirstBatch() {
      document.getElementById('productsList').innerHTML = "";
      lastVisibleDoc = null;
      document.getElementById('loadMoreBtn').classList.add('hidden');
      await fetchProducts();
  }

  window.loadNextBatch = async function() {
      await fetchProducts();
  }

  async function fetchProducts() {
      if (isFetching) return;
      isFetching = true;
      document.getElementById('loadingMsg').style.display = 'block';

      try {
          let q;
          if (!lastVisibleDoc) {
              q = query(productsCol, orderBy("createdAt", "desc"), limit(PRODUCTS_PER_PAGE));
          } else {
              q = query(productsCol, orderBy("createdAt", "desc"), startAfter(lastVisibleDoc), limit(PRODUCTS_PER_PAGE));
          }

          const snapshot = await getDocs(q);

          if (!snapshot.empty) {
              lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
              const products = [];
              snapshot.forEach(doc => products.push({ id: doc.id, ...doc.data() }));

              appendProductsToScreen(products);
              
              if (snapshot.docs.length === PRODUCTS_PER_PAGE) {
                  document.getElementById('loadMoreBtn').classList.remove('hidden');
              } else {
                  document.getElementById('loadMoreBtn').classList.add('hidden');
              }
          } else {
              if (!lastVisibleDoc) {
                  document.getElementById('productsList').innerHTML = '<p style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª.</p>';
              }
              document.getElementById('loadMoreBtn').classList.add('hidden');
          }
      } catch (e) {
          console.log("Fetching error:", e);
          if(e.message.includes("index")) {
               const qFallback = query(productsCol, limit(PRODUCTS_PER_PAGE));
               const snap = await getDocs(qFallback);
               const prods = [];
               snap.forEach(d => prods.push({id: d.id, ...d.data()}));
               appendProductsToScreen(prods);
          }
      } finally {
          isFetching = false;
          document.getElementById('loadingMsg').style.display = 'none';
          updateCount();
      }
  }

  function appendProductsToScreen(products) {
      const listDiv = document.getElementById('productsList');
      products.forEach(p => {
          const thumb = (p.image && p.image.length > 0) ? p.image[0] : '';
          const pData = encodeURIComponent(JSON.stringify(p));

          const row = document.createElement('div');
          row.className = 'product-row';
          row.innerHTML = `
              <div class="p-info">
                  <img src="${thumb}" class="p-img">
                  <div class="p-details">
                      <div>${p.name}</div>
                      <div>${p.price}</div>
                  </div>
              </div>
              <div class="product-actions">
                  <button class="btn-action btn-edit" onclick="openEdit('${pData}')">ØªØ¹Ø¯ÙŠÙ„</button>
                  <button class="btn-action btn-delete" onclick="deleteProd('${p.id}')">Ø­Ø°Ù</button>
              </div>
          `;
          listDiv.appendChild(row);
      });
  }

  function updateCount() {
      const count = document.getElementById('productsList').children.length;
      document.getElementById('count').textContent = count;
  }

  // ==========================================
  // 2. Ø§Ù„Ø¨Ø­Ø« (Ø§Ù„Ø³ÙŠØ±ÙØ±)
  // ==========================================
  window.handleSearch = function(text) {
      clearTimeout(searchTimeout);
      const term = text.trim();
      if(term === "") { loadFirstBatch(); return; }

      searchTimeout = setTimeout(async () => {
          const listDiv = document.getElementById('productsList');
          listDiv.innerHTML = '<div style="text-align:center; color:#999;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';
          document.getElementById('loadMoreBtn').classList.add('hidden');

          try {
              const q = query(productsCol, orderBy('name'), startAt(term), endAt(term + '\uf8ff'), limit(20));
              const snapshot = await getDocs(q);
              listDiv.innerHTML = "";
              if (snapshot.empty) {
                  listDiv.innerHTML = '<div style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>';
              } else {
                  const results = [];
                  snapshot.forEach(doc => results.push({ id: doc.id, ...doc.data() }));
                  appendProductsToScreen(results);
              }
              updateCount();
          } catch (e) { console.error(e); }
      }, 500);
  }

  // ==========================================
  // 3. Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙˆØ± (Ø·Ø±ÙŠÙ‚Ø© Base64)
  // ==========================================
  
  let currentImages = [];
  let newImagesToAdd = [];

  window.openEdit = function(encodedData) {
      const p = JSON.parse(decodeURIComponent(encodedData));
      
      document.getElementById('editProductId').value = p.id;
      document.getElementById('editName').value = p.name;
      document.getElementById('editPrice').value = p.price;
      document.getElementById('editDesc').value = p.description || '';
      
      loadCategories(p.category);
      
      currentImages = p.image || [];
      renderCurrentImages();

      newImagesToAdd = [];
      document.getElementById('editImagesInput').value = '';
      document.getElementById('newImagesPreview').innerHTML = '';
      
      document.getElementById('editModal').style.display = 'flex';
  }

  window.closeModal = function() {
      document.getElementById('editModal').style.display = 'none';
  }

  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø¥Ù„Ù‰ Ø£ÙƒÙˆØ§Ø¯ ÙÙˆØ±Ø§Ù‹
  document.getElementById("editImagesInput").addEventListener("change", function () {
    const files = [...this.files];
    const previewBox = document.getElementById("newImagesPreview");
    
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        const base64String = e.target.result;
        newImagesToAdd.push(base64String);

        const img = document.createElement("img");
        img.src = base64String;
        img.style.cssText = "width:70px; height:70px; border-radius:8px; border:1px solid #ddd; flex-shrink:0;";
        previewBox.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  });

  function renderCurrentImages() {
      const box = document.getElementById('currentImagesPreview');
      box.innerHTML = '';
      currentImages.forEach((url, idx) => {
          const div = document.createElement('div');
          div.className = 'thumb-wrapper';
          div.innerHTML = `<img src="${url}"><button class="thumb-remove" onclick="removeCurrentImage(${idx})">Ã—</button>`;
          box.appendChild(div);
      });
  }

  window.removeCurrentImage = function(idx) {
      if(!confirm("Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©ØŸ")) return;
      currentImages.splice(idx, 1);
      renderCurrentImages();
  }

  // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
  window.submitEditProduct = async function() {
      const btn = document.getElementById('saveBtn');
      const id = document.getElementById('editProductId').value;
      if(!id) return;

      btn.disabled = true;
      btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

      try {
          // Ø¯Ù…Ø¬ Ø§Ù„ØµÙˆØ±
          const finalImages = [...currentImages, ...newImagesToAdd];

          await updateDoc(doc(db, "products", id), {
              name: document.getElementById('editName').value,
              price: document.getElementById('editPrice').value,
              category: document.getElementById('editCategorySelect').value,
              description: document.getElementById('editDesc').value,
              image: finalImages,
              updatedAt: new Date()
          });

          alert("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!");
          closeModal();
          
          if(!document.getElementById('searchInput').value) loadFirstBatch();

      } catch (e) {
          alert("Ø®Ø·Ø£ (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ± ÙƒØ¨ÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹): " + e.message);
      } finally {
          btn.disabled = false;
          btn.textContent = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª";
      }
  }

  // ==========================================
  // 4. Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªØµÙ†ÙŠÙØ§Øª
  // ==========================================
  window.deleteProd = async function(id) {
      if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ")) return;
      try {
          await deleteDoc(doc(db, "products", id));
          loadFirstBatch(); 
      } catch(e) {
          alert("Ø®Ø·Ø£: " + e.message);
      }
  }

  async function loadCategories(selectedCat) {
      try {
          const snap = await getDocs(categoriesCol);
          const select = document.getElementById('editCategorySelect');
          select.innerHTML = '';
          snap.forEach(doc => {
              const opt = document.createElement('option');
              opt.value = doc.data().name;
              opt.textContent = doc.data().name;
              select.appendChild(opt);
          });
          if(selectedCat) select.value = selectedCat;
      } catch(e) { console.log(e); }
  }

  loadFirstBatch();

  window.loadNextBatch = loadNextBatch;
  window.handleSearch = handleSearch;
  window.openEdit = openEdit;
  window.closeModal = closeModal;
  window.removeCurrentImage = removeCurrentImage;
  window.submitEditProduct = submitEditProduct;
  window.deleteProd = deleteProd;

</script>
</body>
</html>
