<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title id="pageTitle">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬...</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --main-color: #007AFF;
    --secondary-color: #FF8C00;
    --bg-color: #f2f2f2;
    --card-bg: #ffffff;
    --text-color: #222;
    --radius: 12px;
  }
  
  /* PWA Styles */
  html,body{ height:100%; margin:0; font-family:'Tajawal',sans-serif; background:var(--bg-color); color:var(--text-color); }
  body{ padding-bottom: 80px; }
  
  /* Header for PWA (Back button) */
  .app-header{
    position:sticky; top:0; left:0; right:0;
    background:var(--card-bg); 
    display:flex; justify-content:space-between; align-items:center;
    padding:12px; box-shadow:0 1px 5px rgba(0,0,0,0.05); z-index:10;
  }
  .back-btn{
    background:none; border:none; color:var(--main-color); font-size:16px; font-weight:700; cursor:pointer;
  }
  
  main{ padding:15px; max-width: 800px; margin: 0 auto; }

  /* Product Slider/Image */
  .product-image-container{ 
    width:100%; 
    padding-top:100%; /* 1:1 Aspect Ratio */
    position:relative; 
    background:#fff; 
    border-radius:var(--radius); 
    overflow:hidden;
    margin-bottom:15px;
  }
  .product-image-container img{
    position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
  }

  /* Details and Price */
  .details-box{ background:var(--card-bg); padding:15px; border-radius:var(--radius); margin-bottom:15px; }
  h1{ margin-top:0; font-size:24px; color:var(--text-color); }
  .price-area{ display:flex; align-items:baseline; gap:8px; margin-bottom:15px; }
  .price{ font-size:28px; font-weight:800; color:#FF0000; }
  .currency{ font-size:14px; font-weight:700; color:#FF0000; }
  .description{ color:#555; line-height:1.6; font-size:15px; }

  /* Action Bar (Fixed Bottom) */
  .action-bar{
    position:fixed; bottom:0; left:0; right:0;
    background:var(--card-bg);
    padding:10px 15px;
    box-shadow:0 -2px 10px rgba(0,0,0,0.1);
    display:flex; gap:10px;
    z-index:100;
  }
  .add-to-cart-btn{
    flex:1; padding:14px; border-radius:99px; border:0;
    background:var(--main-color); color:#fff; font-size:16px; font-weight:800;
    cursor:pointer;
  }
  .whatsapp-btn{
    width:60px; height:60px; border-radius:50%; border:0;
    background:#25D366; color:#fff; font-size:24px;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    box-shadow:0 4px 12px rgba(37,211,102,0.3);
  }

  /* Dark Mode */
  .dark body{ background:#0f1113; color:#e6e6e6; }
  .dark .app-header, .dark .details-box, .dark .action-bar{ 
      background:#111214; 
      box-shadow:0 -2px 10px rgba(255,255,255,0.05);
  }
  .dark h1{ color:#eee; }
  .dark .description{ color:#bbb; }
  .dark .add-to-cart-btn{ background:var(--main-color); }
  .dark .back-btn{ color:var(--secondary-color); }

  /* Loading State */
  .loading-msg{ text-align:center; padding:50px; color:#999; }
</style>
</head>
<body>

<div class="app-header">
    <button class="back-btn" onclick="goBack()">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</button>
    <span id="productNameHeader" style="font-weight:600; font-size:14px;"></span>
</div>

<main id="productDetails">
    <div class="loading-msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬...</div>
</main>

<div class="action-bar">
    <button id="addToCartBtn" class="add-to-cart-btn" onclick="addToCartAndNotify(this)" data-id="">
        ğŸ›’ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©
    </button>
    <button id="whatsappBtn" class="whatsapp-btn" onclick="sendInquiry(this)" data-id="">
        ğŸ’¬
    </button>
</div>


<script type="module">
  // ğŸ”¥ğŸ”¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase Ùˆ Global State Ø§Ù„Ù…Ø´ØªØ±Ùƒ ğŸ”¥ğŸ”¥
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB5mEBB0plplzw_d-gAth-TK0xR523IX6nGg", // ØªØ£ÙƒØ¯ Ù…Ù† Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
    authDomain: "my-fils-575be.firebaseapp.com",
    projectId: "my-fils-575be",
    storageBucket: "my-fils-575be.firebasestorage.app",
    messagingSenderId: "670428095338",
    appId: "1:670428095338:web:75d4a577cc648c208d7b13"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const WHATSAPP = "967773266534";
  
  // ğŸ”¥ğŸ”¥ğŸ”¥ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ (Ø«Ø§Ø¨Øª Ù‡Ù†Ø§) ğŸ”¥ğŸ”¥ğŸ”¥
  const SAR_RATE = 140; 
  const currentCurrency = localStorage.getItem('currentCurrency') || 'YER'; 

  function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
  }

  function goBack() {
      // ÙŠØ¹ÙˆØ¯ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (index.html)
      window.location.href = 'index.html';
  }
  window.goBack = goBack; // Ù„Ø¬Ø¹Ù„Ù‡Ø§ Ù…ØªØ§Ø­Ø© ÙÙŠ HTML

  // ğŸ”¥ğŸ”¥ğŸ”¥ Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬ ğŸ”¥ğŸ”¥ğŸ”¥
  async function renderProduct(productId) {
      const detailsContainer = document.getElementById('productDetails');
      const docRef = doc(db, "products", productId);
      
      try {
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
              const product = docSnap.data();
              
              // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø¹Ù…Ù„Ø©
              let rawPrice = (product.price || "").toString().replace(/[^0-9.]/g, '');
              let priceVal = parseFloat(rawPrice) || 0;
              
              let displayPrice = priceVal.toLocaleString();
              let displayCurrency = 'Ø±.ÙŠ';

              if (currentCurrency === 'SAR') {
                  displayPrice = Math.ceil(priceVal / SAR_RATE).toLocaleString();
                  displayCurrency = 'Ø±.Ø³';
              }

              // 2. ØªØ­Ø¯ÙŠØ« DOM
              document.getElementById('pageTitle').innerText = product.name || 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬';
              document.getElementById('productNameHeader').innerText = product.name || 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬';
              
              const imageSrc = Array.isArray(product.image) ? product.image[0] : (product.image || 'placeholder.png');
              
              detailsContainer.innerHTML = `
                  <div class="product-image-container">
                      <img src="${imageSrc}" alt="${product.name}" loading="eager">
                  </div>
                  <div class="details-box">
                      <h1>${product.name || 'Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</h1>
                      <div class="price-area">
                          <span class="currency">${displayCurrency}</span>
                          <span class="price">${displayPrice}</span>
                      </div>
                      <p class="description">${product.description || 'Ù„Ø§ ÙŠØªÙˆÙØ± ÙˆØµÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø­Ø§Ù„ÙŠØ§Ù‹.'}</p>
                      
                      <div style="margin-top:20px; font-size:14px; color:#999;">
                          Ø±Ù…Ø² Ø§Ù„Ù…Ù†ØªØ¬: ${productId}
                      </div>
                  </div>
              `;
              
              // 3. Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¨Ø§Ù„Ù€ ID
              document.getElementById('addToCartBtn').dataset.id = productId;
              document.getElementById('whatsappBtn').dataset.id = productId;

          } else {
              detailsContainer.innerHTML = `<div class="loading-msg">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬.</div>`;
          }
      } catch (e) {
          console.error("Error fetching document: ", e);
          detailsContainer.innerHTML = `<div class="loading-msg">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>`;
      }
  }

  // ğŸ”¥ğŸ”¥ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© (Ù…Ø´Ø§Ø¨Ù‡Ø© Ù„Ù…Ø§ ÙÙŠ index.html) ğŸ”¥ğŸ”¥ğŸ”¥
  async function addToCartAndNotify(btn) {
      const id = btn.dataset.id;
      if (!id) return;
      
      let cart = JSON.parse(localStorage.getItem("cart") || "[]");
      let item = cart.find(p => p.id === id);
      
      let product;
      if (!item) {
          // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† ÙÙŠ Ø§Ù„Ø³Ù„Ø©
          const docRef = doc(db, "products", id);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
               product = docSnap.data();
               cart.push({ id: id, name: product.name, price: product.price, qty: 1 });
          }
      } else {
          item.qty++;
      }
      
      localStorage.setItem("cart", JSON.stringify(cart));
      
      // Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø³ÙŠØ·
      btn.innerHTML = 'âœ… Ø£ÙØ¶ÙŠÙ Ù„Ù„Ø³Ù„Ø©!';
      btn.style.backgroundColor = '#4CAF50';
      setTimeout(() => {
          btn.innerHTML = 'ğŸ›’ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©';
          btn.style.backgroundColor = 'var(--main-color)';
      }, 1500);
      
      navigator.vibrate?.(40);
  }
  window.addToCartAndNotify = addToCartAndNotify;


  // ğŸ”¥ğŸ”¥ğŸ”¥ Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªÙØ³Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ ğŸ”¥ğŸ”¥ğŸ”¥
  function sendInquiry(btn) {
      const id = btn.dataset.id;
      const productName = document.getElementById('pageTitle').innerText.replace(' | ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬', '');
      const msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ØºØ¨ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØªØ§Ù„ÙŠ:\n*${productName}*\n\nØ±Ù…Ø² Ø§Ù„Ù…Ù†ØªØ¬: ${id}`;
      window.open(`https://wa.me/${WHATSAPP}?text=${encodeURIComponent(msg)}`);
  }
  window.sendInquiry = sendInquiry;


  // ğŸ”¥ğŸ”¥ğŸ”¥ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© ğŸ”¥ğŸ”¥ğŸ”¥
  document.addEventListener('DOMContentLoaded', () => {
      // Dark Mode Check (Ù…Ø£Ø®ÙˆØ° Ù…Ù† index.html)
      if (localStorage.getItem('dark') === '1') {
          document.documentElement.classList.add('dark');
      }

      const id = getQueryParam('id');
      if (id) {
          renderProduct(id);
      } else {
          document.getElementById('productDetails').innerHTML = `<div class="loading-msg">Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬.</div>`;
      }
  });

</script>

</body>
</html>
