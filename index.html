<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

<link rel="manifest" href="manifest.json">

<style>
  :root{
    --main-color: #007AFF;
    --secondary-color: #FF8C00;
    --bg-color: #f2f2f2;
    --card-bg: #ffffff;
    --text-color: #222;
    --nav-height: 60px;
    --total-header-height: 210px;
    --radius: 10px;
  }

  /* ============ Reset & Base ============ */
  *{ box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html,body{ height:100%; margin:0; font-family:'Tajawal',sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  body{
    background:var(--bg-color); color:var(--text-color);
    padding-top:var(--total-header-height); padding-bottom:180px;
    transition: background 0.25s, color 0.25s;
  }

  /* ============ Header (fixed) ============ */
  header{
    position:fixed; inset:0 0 auto 0; height:var(--total-header-height);
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(8px);
    padding-top:5px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.05);
    z-index:100;
    transition: transform 0.28s ease-out, box-shadow 0.2s;
  }
  .header-hidden{ transform: translateY(-100%); box-shadow:none; }

  .top-bar{ height:130px; display:flex; justify-content:center; align-items:center; padding:8px; }
  .store-logo{ height:110px; width:100%; object-fit:contain; display:block; }

  /* Ø²Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
  #darkToggle{
    position:absolute; top:12px; left:12px; z-index:120;
    background: rgba(0,0,0,0.06); border:0; padding:8px 10px; border-radius:8px; cursor:pointer;
    font-weight:700;
  }

  /* Ø§Ù„Ø¨Ø­Ø« */
  .search-container{ width:100%; display:flex; justify-content:center; padding:6px 12px; }
  .search-input-wrapper{
    width:100%; max-width:980px; background:#f5f5f5; border-radius:99px;
    padding:6px 12px; display:flex; align-items:center; gap:8px; border:1px solid #eee;
  }
  .search-input{
    width:100%; background:transparent; border:0; outline:none; font-size:14px; padding:8px 0;
  }
  .search-input::placeholder{ color:#999; }

  /* Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‡ÙŠØ¯Ø± */
  .categories-wrapper{
    padding:10px; overflow-x:auto; white-space:nowrap; border-top:1px solid #f0f0f0; background:transparent;
    -ms-overflow-style:none; scrollbar-width:none; z-index:90;
  }
  .categories-wrapper::-webkit-scrollbar{ display:none; }
  .filter-btn{
    display:inline-block; padding:7px 16px; margin-left:8px; background:#f5f5f5; border-radius:7px; border:0; font-weight:600; cursor:pointer;
  }
  .filter-btn.active{ background:#e6f0ff; color:var(--main-color); font-weight:800; }

  /* ============ Main ============ */
  main{ padding:12px; min-height:60vh; max-width:1100px; margin:0 auto; }
  .view-section{ display:none; animation:fadeIn .18s ease forwards; }
  .view-section.active{ display:block; }
  .products-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }

  /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ */
  .card{ background:var(--card-bg); border-radius:var(--radius); overflow:hidden; position:relative; box-shadow:0 1px 4px rgba(0,0,0,0.03); }
  .card-slider{ position:relative; width:100%; padding-top:100%; background:#fff; overflow:hidden; }
  .card-slider img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity .45s ease; }
  .card-slider img.active{ opacity:1; }

  .add-fab{
    position:absolute; bottom:-15px; left:10px; width:34px; height:34px; background:#fff;
    border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; color:var(--main-color);
    box-shadow:0 4px 12px rgba(0,0,0,0.12); border:1px solid #eee; cursor:pointer; z-index:5;
  }

  .card-body{ padding:12px 10px; padding-top:22px; }
  
  /* ğŸ”¥ğŸ”¥ ØªØ¹Ø¯ÙŠÙ„ Ù„ÙˆÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¥Ù„Ù‰ Ø§Ù„Ø£ØµÙØ± Ø§Ù„Ø°Ù‡Ø¨ÙŠ ğŸ”¥ğŸ”¥ */
  .name{ 
    font-size:13px; font-weight:400; 
    color: #FFC300; 
    margin-bottom:6px; height:34px; overflow:hidden; line-height:1.3;
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
  }
  .price-area{ display:flex; align-items:baseline; gap:6px; flex-wrap:wrap; }
  
  /* ğŸ”¥ğŸ”¥ ØªØ¹Ø¯ÙŠÙ„ Ù„ÙˆÙ† Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ù…Ø± ğŸ”¥ğŸ”¥ */
  .price{ 
    font-size:17px; font-weight:800; 
    color: #FF0000; 
  }
  .currency{ 
    font-size:11px; font-weight:700; 
    color: #FF0000; 
  }
  
  .old-price{ font-size:11px; text-decoration:line-through; color:#999; margin-right:6px; }
  .discount-tag{ background:#fff0e6; color:var(--secondary-color); font-size:9px; padding:2px 6px; border-radius:3px; font-weight:700; }

  .extra-info{ font-size:10px; color:#777; margin-top:6px; }

  /* Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ */
  .cart-item{ display:flex; align-items:center; gap:10px; background:#fff; padding:10px; border-radius:8px; margin-bottom:10px; }
  .qty-btn{ padding:6px 10px; border-radius:6px; background:#fff; cursor:pointer; }

  .shipping-box, .cart-summary{ background:#fff; padding:12px; border-radius:8px; margin:10px 0; }
  .summary-row{ display:flex; justify-content:space-between; margin-bottom:8px; color:#555; }
  .total-row{ border-top:1px solid #eee; padding-top:10px; display:flex; justify-content:space-between; font-weight:800; }
  .final-price{ color:var(--secondary-color); font-size:20px; }

  /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
  #checkoutActionButtons{ position:fixed; bottom:70px; left:10px; right:10px; z-index:95; display:flex; flex-direction:column; gap:8px; }
  .checkout-btn{ width:100%; padding:12px; border-radius:99px; font-weight:800; font-size:16px; border:0; cursor:pointer; }
  #checkoutBtnWhatsapp{ background: linear-gradient(90deg,#FF8C00,#FF6F00); color:#fff; box-shadow:0 6px 18px rgba(255,140,0,0.22); }
  #checkoutBtnPage{ background:#4CAF50; color:#fff; box-shadow:0 6px 18px rgba(76,175,80,0.22); }

  .bottom-nav{ position:fixed; bottom:0; left:0; right:0; height:55px; background:#fff; display:flex; justify-content:space-around; align-items:center; border-top:1px solid #eee; z-index:100; }
  .nav-item{ display:flex; flex-direction:column; align-items:center; gap:3px; color:#777; font-size:10px; font-weight:500; width:50%; padding:6px 0; cursor:pointer; }
  .nav-item.active{ color:var(--main-color); font-weight:700; }
  .nav-badge{ position:absolute; top:6px; margin-right:-12px; background:var(--main-color); color:#fff; font-size:9px; padding:2px 6px; border-radius:10px; border:1px solid #fff; }

  .empty-state{ text-align:center; padding:50px 20px; color:#999; grid-column:span 2; }

  /* Loader */
  .loader{ width:40px; height:40px; border:4px solid #eee; border-top-color:var(--main-color); border-radius:50%; animation:spin 1s linear infinite; margin:40px auto; }
  @keyframes spin{ to{ transform:rotate(360deg); } }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }

  /* Quick View */
  #quickView{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:300; padding:16px; }
  #quickViewBox{ background:#fff; width:100%; max-width:440px; border-radius:12px; overflow:hidden; }

  /* ØªØ¹Ø¯ÙŠÙ„ Ø£Ø¨Ø¹Ø§Ø¯ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ø¥Ù„Ù‰ 1x1 */
  .quick-view-img-wrapper{ width:100%; padding-top:100%; position:relative; overflow:hidden; }
  .quick-view-img-wrapper img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }


  /* Scroll to top button */
  #scrollTopBtn{ position:fixed; bottom:140px; right:14px; width:46px; height:46px; border-radius:50%;
    display:none; align-items:center; justify-content:center; background:var(--main-color); color:#fff; font-size:22px; z-index:220; cursor:pointer; box-shadow:0 8px 24px rgba(0,0,0,0.18);
  }

  /* Dark mode */
  .dark body{ background:#0f1113; color:#e6e6e6; }
  .dark header{ background: rgba(0,0,0,0.54); }
  /* ğŸ”¥ ØªØ¹Ø¯ÙŠÙ„ Ù„ÙˆÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
  .dark .name{ color: #FFC300; }
  /* ğŸ”¥ ØªØ¹Ø¯ÙŠÙ„ Ù„ÙˆÙ† Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
  .dark .price, .dark .currency{ color: #FF0000; }
  
  .dark .card{ background:#111214; box-shadow:0 2px 8px rgba(0,0,0,0.6); }
  .dark .search-input-wrapper{ background:#16181a; border:1px solid #222; }
  .dark .categories-wrapper{ background:transparent; border-top-color:#111; }
  .dark .bottom-nav{ background:#0b0b0d; border-top-color:#111; }
  .dark .shipping-box, .dark .cart-summary{ background:#0f1113; border:1px solid #222; }

  /* Responsive */
  @media(min-width:800px){ .products-grid{ grid-template-columns: repeat(4, 1fr); } }
  @media(min-width:1100px){ main{ padding:20px; } .top-bar{ height:150px } .store-logo{ height:130px } }
</style>
</head>
<body>

<header>
  <button id="darkToggle" title="ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹">ğŸŒ™</button>
  <div class="top-bar">
    <img src="logo.png" alt="Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©" class="store-logo" loading="lazy">
  </div>

  <div class="search-container">
    <div class="search-input-wrapper" role="search">
      <span style="font-size:16px;">ğŸ”</span>
      <input id="searchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø£Ùˆ ØªØµÙ†ÙŠÙ..." oninput="handleSearch(this.value)" />
      <button id="clearSearch" style="border:0;background:transparent;cursor:pointer;font-weight:700;display:none;">âœ–</button>
    </div>
  </div>

  <div class="categories-wrapper" id="categoriesBar" aria-label="Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª">
    <button class="filter-btn active" onclick="filterProducts('all', this)">Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ù„Ùƒ</button>
    <button class="filter-btn" onclick="filterProducts('Ø£Ø¯ÙˆØ§Øª Ù…Ù†Ø²Ù„ÙŠØ©', this)">ğŸ  Ø§Ù„Ù…Ù†Ø²Ù„</button>
    <button class="filter-btn" onclick="filterProducts('Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª', this)">âš¡ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</button>
  </div>
</header>

<main>
  <div id="homeView" class="view-section active">
    <div id="productsGrid" class="products-grid"></div>
  </div>

  <div id="cartView" class="view-section">
    <h3 style="margin-top:0; font-size:16px;">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h3>
    <div id="cartItems"></div>

    <div id="checkoutSection" style="display:none">
      <div class="shipping-box">
        <label style="font-weight:bold; font-size:13px;">ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„:</label>
        <select id="shippingSelect" class="shipping-select" onchange="renderCart()">
          <option value="1000">Ø¯Ø§Ø®Ù„ ØµÙ†Ø¹Ø§Ø¡ (+1,000 Ø±.ÙŠ)</option>
          <option value="2000">Ù…Ø­Ø§ÙØ¸Ø© Ø£Ø®Ø±Ù‰ (+2,000 Ø±.ÙŠ)</option>
        </select>
      </div>

      <div class="cart-summary">
        <div class="summary-row">
          <span>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</span><span id="subTotalDisplay">0</span>
        </div>
        <div class="summary-row">
          <span>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„:</span><span id="shippingDisplay">0</span>
        </div>
        <div class="total-row">
          <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</span><span class="final-price" id="finalTotalDisplay">0</span>
        </div>
      </div>
    </div>

    <div class="empty-state" id="emptyCartMsg" style="display:none">
      <div style="font-size:50px;margin-bottom:10px; opacity:0.3">ğŸ›’</div>
      Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©ØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³ÙˆÙ‚!
    </div>
  </div>
</main>

<div id="checkoutActionButtons" style="display:none">
  <button id="checkoutBtnWhatsapp" class="checkout-btn" onclick="sendCart()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
  <button id="checkoutBtnPage" class="checkout-btn" onclick="prepareAndRedirectToCheckout()">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Ù‹</button>
</div>

<div id="quickView" onclick="if(event.target.id==='quickView')closeQuickView()">
  <div id="quickViewBox"></div>
</div>

<div id="scrollTopBtn" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰">â†‘</div>

<div class="bottom-nav">
  <div class="nav-item active" onclick="switchTab('home')">
    <svg viewBox="0 0 24 24" width="22" height="22"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
  </div>
  <div class="nav-item" onclick="switchTab('cart')" style="position:relative">
    <div class="nav-badge" id="cartBadge" style="display:none">0</div>
    <svg viewBox="0 0 24 24" width="22" height="22"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
    <span>Ø§Ù„Ø³Ù„Ø©</span>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB5mEBB0plzw_d-gAth-TK0xR523IX6nGg",
    authDomain: "my-fils-575be.firebaseapp.com",
    projectId: "my-fils-575be",
    storageBucket: "my-fils-575be.firebasestorage.app",
    messagingSenderId: "670428095338",
    appId: "1:670428095338:web:75d4a577cc648c208d7b13"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const productsCol = collection(db, "products");

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ³
  async function fetchProducts(){
    const grid = document.getElementById("productsGrid");
    grid.innerHTML = `<div style="grid-column:span 2;"><div class="loader"></div></div>`;
    try{
      const snapshot = await getDocs(productsCol);
      const products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      window.allProducts = products || [];
      if(window.renderProducts) window.renderProducts();
    }catch(err){
      console.error(err);
      grid.innerHTML = `<div style='text-align:center; padding:20px; grid-column:span 2; color:#999'>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³.</div>`;
    }
  }

  // Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  fetchProducts();
</script>

<script>
  /* ====================== Global state ====================== */
  const WHATSAPP = "967773266534";
  window.allProducts = window.allProducts || [];
  let cart = JSON.parse(localStorage.getItem("cart")||"[]") || [];
  let currentFilter = "all";

  const grid = document.getElementById("productsGrid");
  const cartItemsContainer = document.getElementById("cartItems");
  const cartBadge = document.getElementById("cartBadge");
  const emptyCartMsg = document.getElementById("emptyCartMsg");
  const checkoutSection = document.getElementById("checkoutSection");
  const checkoutActionButtons = document.getElementById("checkoutActionButtons");

  const subTotalDisplay = document.getElementById("subTotalDisplay");
  const shippingDisplay = document.getElementById("shippingDisplay");
  const finalTotalDisplay = document.getElementById("finalTotalDisplay");
  const shippingSelect = document.getElementById("shippingSelect");

  // Ø¹Ù†Ø§ØµØ± Ø¥Ø¶Ø§ÙÙŠØ©
  const scrollBtn = document.getElementById("scrollTopBtn");
  const quickViewEl = document.getElementById("quickView");
  const quickViewBox = document.getElementById("quickViewBox");
  const searchInput = document.getElementById("searchInput");
  const clearSearch = document.getElementById("clearSearch");
  const darkToggle = document.getElementById("darkToggle");
  const mainHeader = document.querySelector('header');
  let lastScrollTop = 0;
  const headerHeight = mainHeader ? mainHeader.offsetHeight : 210;

  /* ====================== Utils ====================== */
  function saveCart(){
    localStorage.setItem("cart", JSON.stringify(cart));
  }
  function getHashNumber(str){
    let hash=0;
    for(let i=0;i<str.length;i++){ hash = str.charCodeAt(i) + ((hash<<5)-hash); }
    return Math.abs(hash);
  }

  /* ====================== PWA prompt (kept) ====================== */
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    setTimeout(()=> {
      if(deferredPrompt){
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(()=> deferredPrompt = null).catch(()=> deferredPrompt = null);
      }
    }, 3000);
  });

  /* ====================== Scroll hide header ====================== */
  window.addEventListener('scroll', function(){
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    if(scrollTop <= headerHeight/2){
      mainHeader.classList.remove('header-hidden');
      lastScrollTop = scrollTop;
      scrollBtn.style.display = scrollTop > 400 ? "flex" : "none";
      return;
    }
    if(scrollTop > lastScrollTop) mainHeader.classList.add('header-hidden');
    else mainHeader.classList.remove('header-hidden');
    lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
    scrollBtn.style.display = scrollTop > 400 ? "flex" : "none";
  }, { passive:true });

  scrollBtn.onclick = () => window.scrollTo({ top:0, behavior:'smooth' });

  /* ====================== Dark mode ====================== */
  darkToggle.onclick = () => {
    document.documentElement.classList.toggle('dark');
    const on = document.documentElement.classList.contains('dark');
    localStorage.setItem('dark', on ? '1' : '0');
    darkToggle.textContent = on ? 'â˜€ï¸' : 'ğŸŒ™';
  };
  if(localStorage.getItem('dark') === '1'){
    document.documentElement.classList.add('dark');
    darkToggle.textContent = 'â˜€ï¸';
  }

  /* ====================== Tabs ====================== */
  function switchTab(tab){
    document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));

    if(tab === 'home'){
      document.getElementById('homeView').classList.add('active');
      document.querySelector('.nav-item:first-child').classList.add('active');
      renderProducts();
      // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      checkoutActionButtons.style.display = "none"; 
      cart = JSON.parse(localStorage.getItem("cart")||"[]") || [];
      updateCartBadge();
    } else {
      document.getElementById('cartView').classList.add('active');
      document.querySelector('.nav-item:last-child').classList.add('active');
      cart = JSON.parse(localStorage.getItem("cart")||"[]") || [];
      renderCart();
    }
    window.scrollTo({top:0, behavior:'smooth'});
  }

  /* ====================== Search (Ù…Ø­Ø³Ù‘Ù†) ====================== */
  function normalizeStr(s){
    if(!s) return "";
    return s.toString().toLowerCase().trim();
  }

  function handleSearch(q){
    clearSearch.style.display = q ? "inline-block" : "none";
    if(!window.allProducts || !window.allProducts.length){
      drawItems([]);
      return;
    }
    if(!q){
      renderProducts();
      return;
    }
    const nq = normalizeStr(q);
    const items = window.allProducts.filter(p => {
      const name = normalizeStr(p.name || p.title || "");
      const cat = normalizeStr(p.category || "");
      const code = normalizeStr(p.id || "");
      return name.includes(nq) || cat.includes(nq) || code.includes(nq);
    });
    drawItems(items);
  }
  clearSearch.onclick = () => { searchInput.value=''; handleSearch(''); };

  /* ====================== Render & Draw ====================== */
  window.renderProducts = function(){
    let items = currentFilter === 'all' ? (window.allProducts || []) : (window.allProducts || []).filter(p => normalizeStr(p.category) === normalizeStr(currentFilter));
    drawItems(items);
  };

  function filterProducts(cat, btn){
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = cat;
    searchInput.value = "";
    renderProducts();
  }

  // Ø§Ù…Ù†Ø¹ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ù„Ø§ÙŠØ¯Ø± Ù…ØªÙƒØ±Ø±Ø©: ÙƒÙ„ .card-slider ÙŠØ®Ø²Ù† intervalId ÙÙŠ dataset
  function startSlider(){
    document.querySelectorAll(".card-slider").forEach(slider => {
      // Ù†Ø¸Ù Ø£ÙŠ interval Ø³Ø§Ø¨Ù‚
      if(slider._intervalId) { clearInterval(slider._intervalId); slider._intervalId = null; }

      const imgs = slider.querySelectorAll("img");
      if(!imgs || imgs.length <= 1) return;
      let index = 0;
      imgs.forEach((img,i)=> img.classList.toggle('active', i===0));

      // ÙÙ‚Ø· Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ø±ÙƒØ© Ø¥Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ø¶Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶ (Ø®ÙØ© Ø§Ù„Ø£Ø¯Ø§Ø¡) â€” Ø§Ø³ØªØ®Ø¯Ù… IntersectionObserver Ø¥Ù† Ø£Ø±Ø¯Øª Ù„Ø§Ø­Ù‚Ø§
      slider._intervalId = setInterval(()=> {
        imgs[index].classList.remove('active');
        index = (index + 1) % imgs.length;
        imgs[index].classList.add('active');
      }, 3000);
    });
  }

  function drawItems(items){
    grid.innerHTML = "";
    if(!window.allProducts || !window.allProducts.length){
      grid.innerHTML = `<div style="grid-column:span 2;"><div class="loader"></div></div>`;
      return;
    }
    if(items.length === 0){
      grid.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© ğŸ”</div>`;
      return;
    }

    items.forEach(p => {
      const card = document.createElement('div'); card.className = 'card';

      const imgs = Array.isArray(p.image) ? p.image : [p.image || 'placeholder.png'];
      let sliderHTML = `<div class="card-slider" data-id="${p.id}">`;
      imgs.forEach((src, i) => {
        // lazy loading
        const imgSrc = src || 'placeholder.png';
        sliderHTML += `<img data-src="${imgSrc}" ${i===0?'class="active"':""} alt="${(p.name||'')}" loading="lazy">`;
      });
      sliderHTML += `<div class="add-fab" title="Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©" onclick="event.stopPropagation(); addToCart('${p.id}')">+</div></div>`;

      // Ø³Ø¹Ø± Ø®Ø§Ù…
      let rawPrice = (p.price || "").toString().replace(/[^0-9.]/g, '');
      let priceVal = parseFloat(rawPrice) || 0;
      let fakeOldPrice = Math.floor(priceVal * 1.3);

      const hash = getHashNumber(p.id || Math.random().toString(36).slice(2));
      const soldCount = (hash % 901) + 100;

      card.innerHTML = `
        ${sliderHTML}
        <div class="card-body" onclick="openProduct('${p.id}')">
          <div class="name">${p.name || 'Ù…Ù†ØªØ¬'}</div>
          <div class="price-area">
             <span class="currency">Ø±.ÙŠ</span>
             <span class="price">${priceVal.toLocaleString()}</span>
          </div>
          <div style="display:flex; align-items:center; margin-top:6px;">
             <span class="old-price">${fakeOldPrice.toLocaleString()} Ø±.ÙŠ</span>
             <span class="discount-tag">-30%</span>
          </div>
          <div class="extra-info">ØªÙ… Ø¨ÙŠØ¹ ${soldCount}+ Ù‚Ø·Ø¹Ø©</div>
          
          <div style="margin-top:8px; display:flex; gap:8px;">
            <button style="flex:1; padding:8px; border-radius:8px; border:1px solid #eee; background:#fff; cursor:pointer;" onclick="event.stopPropagation(); quickViewById('${p.id}')">ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø³Ø±ÙŠØ¹Ø©</button>
            <button style="flex:1; padding:8px; border-radius:8px; border:0; background:var(--main-color); color:#fff; cursor:pointer;" onclick="event.stopPropagation(); addToCart('${p.id}')">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    });

    // lazy-load Ø§Ù„ØµÙˆØ± ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    document.querySelectorAll('.card-slider img').forEach(img => {
      const src = img.dataset.src || img.src;
      if(img.getAttribute('src') !== src) img.src = src;
    });

    // ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø£ÙŠ intervals Ø«Ù… Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯Ø©
    document.querySelectorAll('.card-slider').forEach(s=> {
      if(s._intervalId){ clearInterval(s._intervalId); s._intervalId = null; }
    });
    startSlider();
  }

  /* ====================== Product interactions ====================== */
  window.openProduct = function(id){
    window.location.href = `product.html?id=${id}`;
  }

  window.addToCart = function(id){
    cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart || [];
    let item = cart.find(p => p.id === id);
    if(item) item.qty++;
    else{
      const p = (window.allProducts||[]).find(x => x.id === id) || { id, name: "Ù…Ù†ØªØ¬", price: "0" };
      cart.push({ id: p.id, name: p.name, price: p.price, qty: 1 });
    }
    saveCart();
    updateCartBadge();
    navigator.vibrate?.(40);
  }

  window.changeQty = function(id, delta){
    cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
    let item = cart.find(i => i.id === id);
    if(!item) return;
    item.qty += delta;
    if(item.qty <= 0) cart = cart.filter(i => i.id !== id);
    saveCart();
    renderCart();
    updateCartBadge();
  }

  function updateCartBadge(){
    cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
    let total = cart.reduce((acc,it)=> acc + (it.qty||0), 0);
    cartBadge.style.display = total > 0 ? "block" : "none";
    cartBadge.textContent = total > 99 ? '99+' : total;
  }

  window.renderCart = function(){
    cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
    cartItemsContainer.innerHTML = "";
    if(cart.length === 0){
      emptyCartMsg.style.display = "block";
      checkoutActionButtons.style.display = "none";
      checkoutSection.style.display = "none";
      return;
    }
    emptyCartMsg.style.display = "none";
    checkoutActionButtons.style.display = "flex";
    checkoutSection.style.display = "block";

    let productTotal = 0;
    cart.forEach(item => {
      let rawPrice = (item.price || "").toString().replace(/[^0-9.]/g,'');
      let priceVal = parseFloat(rawPrice) || 0;
      productTotal += priceVal * (item.qty || 0);

      cartItemsContainer.innerHTML += `
        <div class="cart-item">
          <div style="flex:1">
            <div style="font-weight:700">${item.name}</div>
            <div style="color:#888">${item.price}</div>
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <button class="qty-btn" onclick="changeQty('${item.id}',1)">+</button>
            <div style="font-weight:700">${item.qty}</div>
            <button class="qty-btn" onclick="changeQty('${item.id}',-1)">-</button>
          </div>
        </div>
      `;
    });

    let shippingCost = parseInt(shippingSelect.value || "1000");
    let finalTotal = productTotal + shippingCost;
    subTotalDisplay.innerText = productTotal.toLocaleString() + " Ø±.ÙŠ";
    shippingDisplay.innerText = shippingCost.toLocaleString() + " Ø±.ÙŠ";
    finalTotalDisplay.innerText = finalTotal.toLocaleString() + " Ø±.ÙŠ";
  }

  /* ====================== Send cart via WhatsApp ====================== */
  window.sendCart = function(){
    cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
    if(cart.length === 0) return;
    let msg = "Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:\n\n";
    let productTotal = 0;
    cart.forEach((i, idx) => {
      let rawPrice = (i.price || "").toString().replace(/[^0-9.]/g, '');
      let priceVal = parseFloat(rawPrice) || 0;
      productTotal += priceVal * (i.qty || 0);
      msg += `${idx+1}. ${i.name} (Ø¹Ø¯Ø¯ ${i.qty})\n`;
    });
    const shippingCost = parseInt(shippingSelect.value || "1000");
    const shippingLocation = shippingSelect.options[shippingSelect.selectedIndex].text;
    const finalTotal = productTotal + shippingCost;
    msg += `\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ“ Ø§Ù„ØªÙˆØµÙŠÙ„: ${shippingLocation}\nğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${finalTotal.toLocaleString()} Ø±.ÙŠ`;
    window.open(`https://wa.me/${WHATSAPP}?text=${encodeURIComponent(msg)}`);
  }

  window.prepareAndRedirectToCheckout = function(){
    cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
    if(cart.length === 0) return;
    let productTotal = 0;
    cart.forEach(item => {
      let rawPrice = (item.price || "").toString().replace(/[^0-9.]/g, '');
      productTotal += (parseFloat(rawPrice) || 0) * (item.qty || 0);
    });
    let shippingCost = parseInt(shippingSelect.value || "1000");
    let finalTotal = productTotal + shippingCost;
    let shippingLocation = shippingSelect.options[shippingSelect.selectedIndex].text;
    localStorage.setItem("checkoutSummary", JSON.stringify({
      subTotal: productTotal, finalTotal, shipping:{ cost: shippingCost, location: shippingLocation }
    }));
    window.location.href = 'checkout.html';
  }

  /* ====================== Quick View ====================== */
  function quickViewById(id){
    const p = (window.allProducts || []).find(x => x.id === id);
    if(!p) return quickView({ id, name: 'Ù…Ù†ØªØ¬', price: 0, image: 'placeholder.png' });
    quickView(p);
  }

  function quickView(product){
    const imgs = Array.isArray(product.image) ? product.image : [product.image || 'placeholder.png'];
    const price = (product.price || 0).toString();
    quickViewBox.innerHTML = `
      <div style="display:flex; gap:0; flex-direction:column;">
        <div class="quick-view-img-wrapper">
          <img src="${imgs[0] || 'placeholder.png'}" alt="${product.name||''}">
        </div>
        <div style="padding:14px;">
          <h3 style="margin:0 0 8px 0;">${product.name || ''}</h3>
          <div style="font-size:20px; color:var(--secondary-color); font-weight:800;">${price} Ø±.ÙŠ</div>
          <div style="margin-top:12px; display:flex; gap:8px;">
            <button style="flex:1; padding:10px; border-radius:8px; border:0; background:var(--main-color); color:#fff; font-weight:800;" onclick="addToCart('${product.id}'); closeQuickView();">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
            <button style="flex:1; padding:10px; border-radius:8px; border:1px solid #eee; background:#fff;" onclick="openProduct('${product.id}');">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬</button>
          </div>
        </div>
      </div>
    `;
    quickViewEl.style.display = 'flex';
  }
  function closeQuickView(){ quickViewEl.style.display = 'none'; }

  /* ====================== Quick helpers ====================== */
  window.onpageshow = function(event){
    if(event.persisted || performance?.navigation?.type == 2){
      cart = JSON.parse(localStorage.getItem("cart")||"[]") || [];
      updateCartBadge();
    }
  };

  /* ====================== Initial setup ====================== */
  // Ø±Ù†Ø¯Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ùˆ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ø¨Ø¹Ø¯ (ÙˆØ³ØªØ³ØªØ¨Ø¯Ù„ fetchProducts Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ø§Ø­Ù‚Ø§Ù‹)
  if(!window.allProducts || !window.allProducts.length){
    grid.innerHTML = `<div style="grid-column:span 2;"><div class="loader"></div></div>`;
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠÙ‘Ø©
  updateCartBadge();

  // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¹Ù†Ø¯Ù…Ø§ fetchProducts ÙŠÙ†Ù‡ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ renderProducts Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ module Ø£Ø¹Ù„Ø§Ù‡
  // Ù„ÙƒÙ† Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¥Ø°Ø§ Ù„ÙÙÙØ¸Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©:
  if(window.allProducts && window.allProducts.length) renderProducts();

  /* ====================== Cleanup intervals when leave page ====================== */
  window.addEventListener('beforeunload', ()=> {
    document.querySelectorAll('.card-slider').forEach(s => {
      if(s._intervalId) clearInterval(s._intervalId);
    });
  });
</script>

</body>
</html>
