<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Ù‚Ø§Ø¦Ù…Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #c6a047;
      --bg-color: #f8f9fa;
      --card-bg: #ffffff;
      --text-color: #333;
      --danger: #ff4d4d;
      --success: #4CAF50;
      --warning: #ff9800;
      --aliexpress-red: #FF4747;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--bg-color); color: var(--text-color);
      margin: 0; padding: 0; padding-top: 70px; padding-bottom: 40px;
    }
    header {
      position: fixed; top: 0; left: 0; right: 0;
      height: 60px; background: #fff;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100;
    }
    header h1 { margin: 0; font-size: 18px; font-weight: 800; color: var(--primary); }
    .home-link {
      text-decoration: none; font-size: 14px; font-weight: bold; color: #333;
      background: #eee; padding: 6px 12px; border-radius: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; padding: 16px; }
    .card {
      background: var(--card-bg); border-radius: 20px;
      padding: 20px; margin-bottom: 24px;
      border: 1px solid #f0f0f0; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    }
    h2 { margin-top: 0; font-size: 16px; color: var(--primary); border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
    .product-row { display: flex; align-items: center; justify-content: space-between; background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #f0f0f0; }
    .p-info { display: flex; align-items: center; gap: 10px; }
    .p-img { 
        width: 60px !important; 
        height: 60px !important; 
        max-width: 60px !important; 
        border-radius: 8px; 
        object-fit: cover; 
        background: #eee; 
        flex-shrink: 0; 
    }
    .p-name { font-size: 14px; font-weight: bold; color: #333; }
    .p-price { font-size: 12px; color: var(--primary); }
    
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª */
    .product-actions { display: flex; gap: 8px; }
    .btn-edit { background: #e0f2f1; color: #00897b; border: none; padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; }
    .btn-delete { background: #ffe5e5; color: var(--danger); border: none; padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
    label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #555; }
    input, textarea, select {
      width: 100%; padding: 12px; border-radius: 12px;
      border: 1px solid #eee; background: #f9f9f9;
      font-family: inherit; margin-bottom: 16px; font-size: 14px;
    }
    .btn-primary { 
        width: 100%; padding: 14px; background: var(--primary); color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(198,160,71,0.3); 
    }
    .btn-primary:active { opacity: 0.8; }
    
    /* Ø§Ù„Ù€ Modal */
    .modal { display: none; position: fixed; z-index: 500; padding-top: 60px; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); }
    #editModalContent { background: #fff; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; margin: 50px auto; position: relative; }
    .btn-close-edit { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer; }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± */
    .thumbs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; }
    .thumbs img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; border: 1px solid #eee; flex-shrink: 0; }
    .upload-box { border: 2px dashed #ddd; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; margin-bottom: 16px; background: #fafafa; }
    /* ØªÙ†Ø³ÙŠÙ‚ ØµÙˆØ± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¹ Ø²Ø± Ø§Ù„Ø­Ø°Ù */
    .edit-thumbs img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; border: 1px solid #eee; flex-shrink: 0; }
  </style>
</head>
<body>

<header>
  <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
  <a href="admin_dashboard.html" class="home-link">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… âš™ï¸</a>
</header>

<div class="container">
  
  <div class="card">
    <h2>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± (<span id="count">0</span>)</h2>
    <div id="productsList">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div>
  </div>

</div>

<div id="editModal" class="modal" style="display:none;">
    <div id="editModalContent">
        <button class="btn-close-edit" onclick="document.getElementById('editModal').style.display='none'">&times;</button>
        <h2>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h2>
        <input type="hidden" id="editProductId">

        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
        <input type="text" id="editName">
        
        <label>Ø§Ù„Ø³Ø¹Ø±</label>
        <input type="text" id="editPrice">
        
        <label>Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
        <select id="editCategorySelect"></select>

        <label>Ø§Ù„ÙˆØµÙ</label>
        <textarea id="editDesc"></textarea>

        <label>Ø¥Ø¶Ø§ÙØ© ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</label>
        <div class="upload-box" onclick="document.getElementById('editImagesInput').click()" style="margin-bottom: 5px;">
          <span class="upload-icon">ğŸ“·</span>
          <span class="upload-text">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§</span>
        </div>
        <input type="file" id="editImagesInput" accept="image/*" multiple style="display:none;">
        <div class="thumbs" id="editPreviewBoxNew" style="margin-bottom: 16px;"></div>

        <label>Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ 'x' Ù„Ø­Ø°Ù ØµÙˆØ±Ø©)</label>
        <div class="edit-thumbs" id="editCurrentImages" style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px;"></div>
        
        <button class="btn-primary" onclick="submitEditProduct()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";


  const firebaseConfig = {
    apiKey: "AIzaSyB5mEBB0plzw_d-gAth-TK0xR523IX6nGg",
    authDomain: "my-fils-575be.firebaseapp.com",
    projectId: "my-fils-575be",
    storageBucket: "my-fils-575be.firebasestorage.app",
    messagingSenderId: "670428095338",
    appId: "1:670428095338:web:75d4a577cc648c208d7b13"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app); 

  const productsCol = collection(db, "products"); 
  const categoriesCol = collection(db, "categories");
  let categories = []; 
  
  let selectedFilesForEdit = []; // Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
  let currentImageURLs = [];     // Ù‚Ø§Ø¦Ù…Ø© Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ù†ØªØ¬

  // ------------------------------------------------------------------
  // 1. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª (Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±)
  // ------------------------------------------------------------------

  async function fetchCategories() {
      try {
          const snapshot = await getDocs(categoriesCol);
          categories = snapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
          updateCategorySelectors();
      } catch (e) {
          console.error("Error fetching categories:", e);
          categories = [
              { id: '1', name: 'Ø£Ø¯ÙˆØ§Øª Ù…Ù†Ø²Ù„ÙŠØ©' },
              { id: '2', name: 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª' }
          ];
          updateCategorySelectors();
      }
  }

  function updateCategorySelectors() {
      const editSelect = document.getElementById('editCategorySelect');
      editSelect.innerHTML = '';

      categories.forEach(cat => {
          const option = new Option(cat.name, cat.name);
          editSelect.appendChild(option.cloneNode(true));
      });
  }

  // ------------------------------------------------------------------
  // 2. Ø¥Ø¯Ø§Ø±Ø© ØµÙˆØ± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  // ------------------------------------------------------------------

  document.getElementById("editImagesInput").addEventListener("change", function () {
    selectedFilesForEdit = [...this.files]; 
    const previewBox = document.getElementById("editPreviewBoxNew");
    previewBox.innerHTML = "";

    if(selectedFilesForEdit.length > 0) document.querySelector('#editModalContent .upload-text').textContent = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${selectedFilesForEdit.length} ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©`;

    selectedFilesForEdit.forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.createElement("img");
        img.src = e.target.result;
        previewBox.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  });

  // ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  window.deleteImageFromEdit = function(productId, indexToRemove) {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©ØŸ (Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª')")) return;
      
      currentImageURLs.splice(indexToRemove, 1); 
      
      const editCurrentImagesBox = document.getElementById('editCurrentImages');
      editCurrentImagesBox.innerHTML = '';

      currentImageURLs.forEach((imgSrc, index) => {
          const imgWrapper = document.createElement("div");
          imgWrapper.style.position = 'relative';
          imgWrapper.style.display = 'inline-block';
          imgWrapper.style.marginLeft = '8px';

          const img = document.createElement("img");
          img.src = imgSrc;
          imgWrapper.appendChild(img);
          
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = 'x';
          deleteBtn.style.cssText = 'position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 15px; height: 15px; font-size: 10px; padding: 0; line-height: 1; border: none; cursor: pointer;';
          
          deleteBtn.onclick = () => { deleteImageFromEdit(productId, index); };
          imgWrapper.appendChild(deleteBtn);
          
          editCurrentImagesBox.appendChild(imgWrapper);
      });
      
      alert("ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¤Ù‚ØªØ§Ù‹. Ø§Ø¶ØºØ· 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±.");
  }


  // ğŸ”¥ Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  window.openEditModal = function(buttonElement) {
      const productJson = buttonElement.getAttribute('data-product');
      if (!productJson) return;
      
      const p = JSON.parse(productJson.replace(/&quot;/g, '"'));

      // 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©
      selectedFilesForEdit = [];
      document.getElementById("editPreviewBoxNew").innerHTML = '';
      document.querySelector('#editModalContent .upload-text').textContent = `Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§`;
      
      currentImageURLs = p.image || []; 
      
      // 2. Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      document.getElementById('editProductId').value = p.id;
      document.getElementById('editName').value = p.name;
      document.getElementById('editPrice').value = p.price;
      document.getElementById('editDesc').value = p.description;

      const select = document.getElementById('editCategorySelect');
      setTimeout(() => { select.value = p.category; }, 500); 
      
      // 3. Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø¹ Ø®ÙŠØ§Ø± Ø§Ù„Ø­Ø°Ù (ÙŠØ³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© deleteImageFromEdit)
      const editCurrentImagesBox = document.getElementById('editCurrentImages');
      editCurrentImagesBox.innerHTML = '';
      
      currentImageURLs.forEach((imgSrc, index) => {
          const imgWrapper = document.createElement("div");
          imgWrapper.style.position = 'relative';
          imgWrapper.style.display = 'inline-block';
          imgWrapper.style.marginLeft = '8px';

          const img = document.createElement("img");
          img.src = imgSrc;
          imgWrapper.appendChild(img);
          
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = 'x';
          deleteBtn.style.cssText = 'position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 15px; height: 15px; font-size: 10px; padding: 0; line-height: 1; border: none; cursor: pointer;';
          
          deleteBtn.onclick = () => { deleteImageFromEdit(p.id, index); };
          imgWrapper.appendChild(deleteBtn);
          
          editCurrentImagesBox.appendChild(imgWrapper);
      });

      document.getElementById('editModal').style.display = 'flex';
  }


  // ğŸ”¥ Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  window.submitEditProduct = async function() {
      const id = document.getElementById('editProductId').value;
      const name = document.getElementById('editName').value.trim();
      const price = document.getElementById('editPrice').value.trim();
      const description = document.getElementById('editDesc').value.trim();
      const category = document.getElementById('editCategorySelect').value;
      
      if (!name || !price) {
          alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ø³Ø¹Ø±.");
          return;
      }

      const btn = document.querySelector('#editModalContent .btn-primary');
      btn.textContent = "Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª...";
      btn.disabled = true;
      
      try {
          // 1. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
          const newImageURLs = [];
          
          if (selectedFilesForEdit.length > 0) {
              btn.textContent = `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${selectedFilesForEdit.length} ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©...`;
              
              for (let i = 0; i < selectedFilesForEdit.length; i++) {
                  const file = selectedFilesForEdit[i];
                  const fileExtension = file.name.split('.').pop();
                  const storagePath = `products_images/${id}_edit_${Date.now()}_${i}.${fileExtension}`;
                  const storageRef = ref(storage, storagePath);

                  await uploadBytes(storageRef, file);
                  const url = await getDownloadURL(storageRef);
                  newImageURLs.push(url);
                  
                  btn.textContent = `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ${i + 1} Ù…Ù† ${selectedFilesForEdit.length}...`;
              }
          }
          
          // 2. Ø¯Ù…Ø¬ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø±ØªØ¨Ø©: Ø§Ù„ØµÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù) + Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          const finalImageURLs = currentImageURLs.concat(newImageURLs);
          
          if (finalImageURLs.length === 0) {
              alert("ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù†ØªØ¬ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!");
              btn.textContent = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª";
              btn.disabled = false;
              return;
          }

          // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Firestore
          btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬...";
          const productRef = doc(db, "products", id);
          await updateDoc(productRef, {
              name: name,
              price: price,
              description: description,
              category: category,
              image: finalImageURLs, 
              updatedAt: new Date()
          });
          
          alert("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!");
          document.getElementById('editModal').style.display = 'none';
          renderProducts();
      } catch (e) {
          console.error("Error updating document: ", e);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + e.message);
      } finally {
          btn.textContent = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª";
          btn.disabled = false;
      }
  }

  // ------------------------------------------------------------------
  // 3. Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ ÙˆØ­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  // ------------------------------------------------------------------

  window.deleteProduct = async function(id) {
    if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±ØŸ")) return;
    try {
        await deleteDoc(doc(db, "products", id));
        renderProducts();
    } catch(e) {
        alert("Ø®Ø·Ø£: " + e.message);
    }
  }

  async function renderProducts() {
    const box = document.getElementById("productsList");
    try {
        const snapshot = await getDocs(productsCol);
        box.innerHTML = "";
        document.getElementById("count").textContent = snapshot.docs.length;

        if (snapshot.docs.length === 0) {
            box.innerHTML = "<div style='text-align:center;color:#777;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹</div>";
            return;
        }

        snapshot.docs.forEach(docSnap => {
          const p = docSnap.data();
          const pId = docSnap.id;
          const thumb = Array.isArray(p.image) && p.image.length > 0 ? p.image[0] : '';
          
          const productData = {
              id: pId,
              name: p.name,
              price: p.price,
              description: p.description || '',
              category: p.category,
              image: p.image || []
          };
          const productJson = JSON.stringify(productData).replace(/"/g, '&quot;'); 
          
          const row = document.createElement("div");
          row.className = "product-row";
          
          row.innerHTML = `
            <div class="p-info">
              <img src="${thumb}" class="p-img">
              <div>
                <div class="p-name">${p.name}</div>
                <div class="p-price">${p.price}</div>
                <div style="font-size:11px; color:#999;">Ø§Ù„ØªØµÙ†ÙŠÙ: ${p.category || 'ØºÙŠØ± Ù…ØµÙ†Ù'}</div>
              </div>
            </div>
            <div class="product-actions">
                <button class="btn-edit" onclick="openEditModal(this)" data-product='${productJson}'>ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn-delete" onclick="deleteProduct('${pId}')">Ø­Ø°Ù</button>
            </div>
          `;
          box.appendChild(row);
        });
    } catch (e) {
        box.innerHTML = `<div style='color:red;text-align:center'>ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase</div>`;
        console.error(e);
    }
  }

  // 4. Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
  fetchCategories(); 
  renderProducts();
</script>
</body>
</html>
